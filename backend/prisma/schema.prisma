// Prisma Schema for SSA Intelligence Research Platform
// Uses PostgreSQL with new section naming convention

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Main research job - tracks complete company intelligence generation
model ResearchJob {
  id                String    @id @default(cuid())
  
  // Job status
  status            String    // 'queued' | 'pending' | 'running' | 'completed' | 'failed'
  currentStage      String?   // Current stage being executed
  progress          Float     @default(0) // 0.0 to 1.0
  queuedAt          DateTime  @default(now())
  startedAt         DateTime?
  
  // Research inputs
  companyName       String
  normalizedCompany String
  geography         String
  normalizedGeography String
  industry          String?
  normalizedIndustry String?
  domain            String?
  normalizedDomain  String?
  focusAreas        String[]  @default([])
  reportType        ReportType @default(GENERIC)
  selectedSections  String[]  @default([])
  userAddedPrompt   String?
  visibilityScope   VisibilityScope @default(PRIVATE)
  
  // Research outputs (stored as JSON matching TypeScript interfaces)
  foundation            Json?  // FoundationOutput
  execSummary           Json?  // Section1Output (renamed for consistency)
  financialSnapshot     Json?  // Section2Output
  companyOverview       Json?  // Section3Output
  segmentAnalysis       Json?  // Section4Output
  trends                Json?  // Section5Output
  peerBenchmarking      Json?  // Section6Output
  skuOpportunities      Json?  // Section7Output
  recentNews            Json?  // Section8Output
  conversationStarters  Json?  // Section9Output
  appendix              Json?  // Section10Output
  
  // Metadata
  overallConfidence String?   // 'HIGH' | 'MEDIUM' | 'LOW'
  overallConfidenceScore Float?
  metadata          Json      @default("{}") // Additional context (user files, etc.)
  
  // Relations
  subJobs           ResearchSubJob[]
  jobGroups         ResearchJobGroup[]
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId            String
  
  // Token usage and cost tracking
  promptTokens      Int       @default(0)
  completionTokens  Int       @default(0)
  costUsd           Float     @default(0)
  thumbnailUrl      String?

  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  completedAt       DateTime?
  
  @@index([userId, status])
  @@index([createdAt])
  @@index([status])
  @@index([status, queuedAt])
  @@index([normalizedDomain])
  @@index([reportType])
  @@index([visibilityScope])
  @@unique([userId, normalizedCompany, normalizedGeography, normalizedIndustry, reportType])
}

// Individual section/stage execution tracking
model ResearchSubJob {
  id           String      @id @default(cuid())
  
  // Parent job
  researchId   String
  research     ResearchJob @relation(fields: [researchId], references: [id], onDelete: Cascade)
  
  // Stage information (using app naming convention)
  stage        String      // 'foundation' | 'exec_summary' | 'financial_snapshot' | etc.
  status       String      // 'pending' | 'running' | 'completed' | 'failed'
  dependencies String[]    // Array of stage names this depends on
  
  // Execution tracking
  attempts     Int         @default(0)
  maxAttempts  Int         @default(3)
  lastError    String?
  promptTokens     Int     @default(0)
  completionTokens Int     @default(0)
  costUsd          Float   @default(0)
  
  // Output data
  output       Json?       // Section-specific output
  confidence   String?     // 'HIGH' | 'MEDIUM' | 'LOW'
  sourcesUsed  String[]    @default([]) // ["S1", "S2", "S3"]
  
  // Timing
  startedAt    DateTime?
  completedAt  DateTime?
  duration     Int?        // Milliseconds
  
  // Timestamps
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  
  @@unique([researchId, stage])
  @@index([researchId, status])
  @@index([status])
}

// User model
model User {
  id        String        @id @default(cuid())
  email     String        @unique
  name      String?
  role      UserRole      @default(MEMBER)
  
  // Relations
  research  ResearchJob[]
  memberships GroupMembership[]
  
  // Timestamps
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  
  @@index([email])
}

model Group {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships GroupMembership[]
  jobGroups   ResearchJobGroup[]

  @@index([name])
}

model GroupMembership {
  id        String   @id @default(cuid())
  userId    String
  groupId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@index([groupId])
  @@index([userId])
}

model ResearchJobGroup {
  id        String   @id @default(cuid())
  jobId     String
  groupId   String
  createdAt DateTime @default(now())

  job   ResearchJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  group Group       @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([jobId, groupId])
  @@index([groupId])
  @@index([jobId])
}

enum UserRole {
  ADMIN
  MEMBER
}

enum VisibilityScope {
  PRIVATE
  GROUP
  GENERAL
}

enum ReportType {
  GENERIC
  INDUSTRIALS
  PE
  FS
}

// Optional: API Key management for users
model ApiKey {
  id        String   @id @default(cuid())
  key       String   @unique
  name      String
  userId    String
  lastUsed  DateTime?
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([key])
}

// User feedback submissions
model Feedback {
  id         String   @id @default(cuid())
  name       String?
  email      String?
  message    String
  pagePath   String?
  reportId   String?
  createdAt  DateTime @default(now())
  
  @@index([createdAt])
}
